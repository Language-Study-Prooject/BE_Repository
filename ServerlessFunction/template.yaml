AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Group2 English Study - Unified API (Chatting + Vocabulary)

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: java21
    Architectures:
      - x86_64
    Environment:
      Variables:
        CHAT_TABLE_NAME: !Ref ChatTable
        VOCAB_TABLE_NAME: !Ref VocabTable
        CHAT_BUCKET_NAME: group2-englishstudy
        VOCAB_BUCKET_NAME: group2-englishstudy
        AWS_REGION_NAME: !Ref AWS::Region

Resources:
  #############################################
  # API Gateway (Unified)
  #############################################

  MainApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: group2-englishstudy-api
      StageName: dev
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
        AllowOrigin: "'*'"

  #############################################
  # Chatting Lambda Functions
  #############################################

  ChatRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-room-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatRoomHandler::handleRequest
      Description: Handle chat room CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
      Events:
        CreateRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: POST
        GetRooms:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: GET
        GetRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: GET
        DeleteRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: DELETE
        JoinRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/join
            Method: POST
        LeaveRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/leave
            Method: POST

  ChatMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-message-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatMessageHandler::handleRequest
      Description: Handle chat messages
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: POST
        GetMessages:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: GET
        GetMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages/{messageId}
            Method: GET

  ChatAIFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-ai-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatAIHandler::handleRequest
      Description: Generate AI responses using Bedrock
      Timeout: 60
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
      Events:
        GenerateAI:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/ai/generate
            Method: POST

  ChatVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-voice-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatVoiceHandler::handleRequest
      Description: Convert text to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/voice/synthesize
            Method: POST

  #############################################
  # Vocabulary Lambda Functions
  #############################################

  WordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-word-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordHandler::handleRequest
      Description: Handle word CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: POST
        BatchCreateWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch
            Method: POST
        SearchWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/search
            Method: GET
        GetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: GET
        GetWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: GET
        UpdateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: PUT
        DeleteWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: DELETE

  UserWordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-userword-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.UserWordHandler::handleRequest
      Description: Handle user word learning status
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetUserWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words
            Method: GET
        GetUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words/{wordId}
            Method: GET
        UpdateUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words/{wordId}
            Method: PUT
        UpdateUserWordTag:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words/{wordId}/tag
            Method: PUT

  DailyStudyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-daily-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.DailyStudyHandler::handleRequest
      Description: Handle daily study word assignment
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetDailyWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily/{userId}
            Method: GET
        MarkWordLearned:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily/{userId}/words/{wordId}/learned
            Method: POST

  TestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-test-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.TestHandler::handleRequest
      Description: Handle vocabulary tests
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TEST_RESULT_TOPIC_ARN: !Ref TestResultTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt TestResultTopic.TopicName
      Events:
        StartTest:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/start
            Method: POST
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/submit
            Method: POST
        GetTestResult:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/results
            Method: GET

  StatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-stats-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatsHandler::handleRequest
      Description: Handle user learning statistics
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/{userId}
            Method: GET
        GetDailyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/{userId}/daily
            Method: GET
        GetWeaknessAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/{userId}/weakness
            Method: GET

  VocabVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-voice-handler
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.VoiceHandler::handleRequest
      Description: Convert word to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/voice/synthesize
            Method: POST

  #############################################
  # DynamoDB Tables
  #############################################

  ChatTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-chat
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  VocabTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-vocab
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  #############################################
  # SNS / SQS for Async Statistics Processing
  #############################################

  # SNS Topic - 시험 결과 이벤트 발행
  TestResultTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: group2-englishstudy-test-result-topic

  # SQS Dead Letter Queue - 실패한 메시지 보관
  StatisticsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: group2-englishstudy-statistics-dlq
      MessageRetentionPeriod: 1209600  # 14일

  # SQS Queue - 통계 처리용
  StatisticsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: group2-englishstudy-statistics-queue
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt StatisticsDeadLetterQueue.Arn
        maxReceiveCount: 3

  # SQS Queue Policy - SNS에서 메시지 수신 허용
  StatisticsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref StatisticsQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt StatisticsQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref TestResultTopic

  # SNS → SQS 구독
  StatisticsQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref TestResultTopic
      Endpoint: !GetAtt StatisticsQueue.Arn
      RawMessageDelivery: true

  # Statistics Processor Lambda - SQS에서 메시지 소비하여 통계 업데이트
  StatisticsProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-statistics-processor
      CodeUri: ServerlessFunction
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatisticsHandler::handleRequest
      Description: Process test results and update user word statistics
      Timeout: 60
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SQSPollerPolicy:
            QueueName: !GetAtt StatisticsQueue.QueueName
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt StatisticsQueue.Arn
            BatchSize: 10

#############################################
# Outputs
#############################################

Outputs:
  ApiUrl:
    Description: Unified API Gateway endpoint URL
    Value: !Sub 'https://${MainApi}.execute-api.${AWS::Region}.amazonaws.com/dev/'

  ChatTableName:
    Description: Chat DynamoDB Table Name
    Value: !Ref ChatTable

  VocabTableName:
    Description: Vocab DynamoDB Table Name
    Value: !Ref VocabTable

  BucketName:
    Description: S3 Bucket Name
    Value: group2-englishstudy
