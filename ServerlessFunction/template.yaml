AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Group2 English Study - Unified API (Chatting + Vocabulary)

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: java21
    Architectures:
      - x86_64
    Tracing: Active
    Environment:
      Variables:
        USER_TABLE_NAME: !Ref UserTable
        CHAT_TABLE_NAME: !Ref ChatTable
        VOCAB_TABLE_NAME: !Ref VocabTable
        OPIC_TABLE_NAME: !Ref OPIcTable
        BUCKET_NAME: group2-englishstudy
        CHAT_BUCKET_NAME: group2-englishstudy
        VOCAB_BUCKET_NAME: group2-englishstudy
        PROFILE_BUCKET_NAME: group2-englishstudy
        OPIC_BUCKET_NAME: group2-englishstudy
        AWS_REGION_NAME: !Ref AWS::Region
        ROOM_TOKEN_TTL_SECONDS: "300"
        TRANSCRIBE_PROXY_URL: "https://tfo1zm7vec.execute-api.ap-northeast-2.amazonaws.com/prod/transcribe"
  Api:
    TracingEnabled: true

Resources:
  #############################################
  # Cognito User Pool
  #############################################

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Retain
    # UpdateReplacePolicy: Retain
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-userpool"
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: false
      # Cognito에 저장할 사용자 정보 정의 ≈ 회원 테이블 컬럼
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: nickname
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: level
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: profileUrl
          AttributeDataType: String
          Required: false
          Mutable: true
      LambdaConfig:
        PreSignUp: !GetAtt PreSignUpFunction.Arn
        PostConfirmation: !GetAtt PostConfirmationFunction.Arn

  # Cognito에게 Lambda 호출 권한 부여
  PreSignUpPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref PreSignUpFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*

  PostConfirmationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt PostConfirmationFunction.Arn
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt CognitoUserPool.Arn

  # 사용자 custom 속성들 기본값 설정 Lambda 함수
  PreSignUpFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-pre-signup"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.PreSignUpHandler::handleRequest
      Description: Set default values for new users (nickname, level, picture)
      MemorySize: 256
      Timeout: 10
      Environment:
        Variables:
          DEFAULT_PROFILE_URL: https://group2-englishstudy.s3.amazonaws.com/profile/default.png

  # 회원가입 시점에 사용자 모든 정보가 DB에 저장 Lambda 함수
  PostConfirmationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-post-confirmation"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.PostConfirmationHandler::handleRequest
      Description: Handle user registration - save to DynamoDB
      MemorySize: 1024
      Timeout: 5
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserTable

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${AWS::StackName}-client"
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
      PreventUserExistenceErrors: ENABLED

  #############################################
  # API Gateway (Unified)
  #############################################

  MainApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: group2-englishstudy-api
      StageName: dev
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
        AllowOrigin: "'*'"

      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt CognitoUserPool.Arn
            Identity:
              Header: Authorization

  #############################################
  # WebSocket API Gateway
  #############################################

  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: group2-englishstudy-websocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref WebSocketApi
      StageName: dev
      AutoDeploy: true

  # WebSocket Connect Route
  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub integrations/${ConnectIntegration}

  ConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations

  # WebSocket Disconnect Route
  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub integrations/${DisconnectIntegration}

  DisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations

  # WebSocket SendMessage Route
  SendMessageRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: sendMessage
      AuthorizationType: NONE
      Target: !Sub integrations/${SendMessageIntegration}

  SendMessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketMessageFunction.Arn}/invocations

  #############################################
  # WebSocket Lambda Functions
  #############################################

  WebSocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-ws-connect
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketConnectHandler::handleRequest
      Description: Handle WebSocket $connect
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_CONNECTION_TTL_SECONDS: "600"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable

  WebSocketConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$connect

  WebSocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-ws-disconnect
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketDisconnectHandler::handleRequest
      Description: Handle WebSocket $disconnect
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable

  WebSocketDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$disconnect

  WebSocketMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-ws-message
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketMessageHandler::handleRequest
      Description: Handle WebSocket sendMessage
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev"
          GAME_AUTO_CLOSE_LAMBDA_ARN: !GetAtt GameAutoCloseFunction.Arn
          SCHEDULER_ROLE_ARN: !GetAtt GameSchedulerRole.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
        # EventBridge Scheduler 권한
        - Statement:
            - Effect: Allow
              Action:
                - scheduler:CreateSchedule
                - scheduler:DeleteSchedule
                - scheduler:GetSchedule
              Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/game-auto-close/*"
        - Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt GameSchedulerRole.Arn

  WebSocketMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketMessageFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/sendMessage

  #############################################
  # User Lambda Functions
  #############################################

  UserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-user-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.UserHandler::handleRequest
      Description: Handle user profile CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
      Events:
        GetMyProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /users/profile/me
            Method: GET
        UpdateMyProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /users/profile/me
            Method: PUT
        UploadProfileImage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /users/profile/me/image
            Method: POST

  #############################################
  # Chatting Lambda Functions
  #############################################

  ChatRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-room-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatRoomHandler::handleRequest
      Description: Handle chat room CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
      Events:
        CreateRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetRooms:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer
        JoinRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/join
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        LeaveRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/leave
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GameFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-game-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.GameHandler::handleRequest
      Description: Handle catch-mind game operations
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev"
          GAME_AUTO_CLOSE_LAMBDA_ARN: !GetAtt GameAutoCloseFunction.Arn
          SCHEDULER_ROLE_ARN: !GetAtt GameSchedulerRole.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"
        # EventBridge Scheduler 권한
        - Statement:
            - Effect: Allow
              Action:
                - scheduler:CreateSchedule
                - scheduler:DeleteSchedule
                - scheduler:GetSchedule
              Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/game-auto-close/*"
        - Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt GameSchedulerRole.Arn
      Events:
        StartGame:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/start
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        StopGame:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/stop
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetGameStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/status
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetScores:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/scores
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  # 게임 자동 종료 Lambda (EventBridge Scheduler에 의해 호출)
  GameAutoCloseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-game-auto-close
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.GameAutoCloseHandler::handleRequest
      Description: Auto-close game after 7 minutes
      Timeout: 30
      MemorySize: 512
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

  # EventBridge Scheduler가 Lambda를 호출할 수 있는 IAM Role
  GameSchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-game-scheduler-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeGameAutoCloseLambda
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt GameAutoCloseFunction.Arn

  # EventBridge Schedule Group
  GameScheduleGroup:
    Type: AWS::Scheduler::ScheduleGroup
    Properties:
      Name: game-auto-close

  ChatMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-message-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatMessageHandler::handleRequest
      Description: Handle chat messages
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetMessages:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages/{messageId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  ChatVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-voice-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatVoiceHandler::handleRequest
      Description: Convert text to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/voice/synthesize
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  #############################################
  # Vocabulary Lambda Functions
  #############################################

  WordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-word-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordHandler::handleRequest
      Description: Handle word CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: POST
            Auth:
              Authorizer: NONE
        BatchCreateWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch
            Method: POST
            Auth:
              Authorizer: NONE
        BatchGetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch/get
            Method: POST
            Auth:
              Authorizer: NONE
        SearchWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/search
            Method: GET
            Auth:
              Authorizer: NONE
        GetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: GET
            Auth:
              Authorizer: NONE
        GetWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: GET
            Auth:
              Authorizer: NONE
        UpdateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: PUT
            Auth:
              Authorizer: NONE
        DeleteWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: DELETE
            Auth:
              Authorizer: NONE

  UserWordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-userword-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.UserWordHandler::handleRequest
      Description: Handle user word learning status
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetWrongAnswers:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/wrong-answers
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetUserWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateUserWordTag:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}/tag
            Method: PATCH
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateUserWordStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}/status
            Method: PATCH
            Auth:
              Authorizer: CognitoAuthorizer

  WordGroupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-wordgroup-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordGroupHandler::handleRequest
      Description: Handle user custom word groups
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetGroups:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetGroupDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer
        AddWordToGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}/words/{wordId}
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        RemoveWordFromGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}/words/{wordId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  DailyStudyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-daily-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.DailyStudyHandler::handleRequest
      Description: Handle daily study word assignment
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetDailyWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        MarkWordLearned:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily/words/{wordId}/learned
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  TestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-test-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.TestHandler::handleRequest
      Description: Handle vocabulary tests
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TEST_RESULT_TOPIC_ARN: !Ref TestResultTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt TestResultTopic.TopicName
      Events:
        StartTest:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/start
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/submit
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetTestResults:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/results
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetTestResultDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/results/{testId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetTestedWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/tested-words
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  StatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-stats-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatsHandler::handleRequest
      Description: Handle user learning statistics
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetDailyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/daily
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetWeaknessAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/weakness
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  VocabVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-voice-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.VoiceHandler::handleRequest
      Description: Convert word to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/voice/synthesize
            Method: POST
            Auth:
              Authorizer: NONE

  #############################################
  # Stats Lambda Functions (DynamoDB Streams)
  #############################################

  # DynamoDB Streams 트리거 - 테스트 결과 저장 시 통계 자동 업데이트
  StatsStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-stats-stream-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.stats.handler.StatsStreamHandler::handleRequest
      Description: Process DynamoDB Streams for stats aggregation
      Timeout: 60
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt VocabTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 100
            FilterCriteria:
              Filters:
                - Pattern: '{"eventName": ["INSERT"], "dynamodb": {"NewImage": {"PK": {"S": [{"prefix": "TEST#"}]}}}}'

  # 사용자 통계 조회 API Handler
  UserStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-user-stats-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.stats.handler.UserStatsHandler::handleRequest
      Description: Handle user learning statistics API
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetDailyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/daily
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetWeeklyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/weekly
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetMonthlyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/monthly
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetTotalStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/total
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetStatsHistory:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/history
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  # Badge Lambda Function
  BadgeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-badge-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.badge.handler.BadgeHandler::handleRequest
      Description: Handle user badges and achievements
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3ReadPolicy:
            BucketName: group2-englishstudy
      Events:
        GetAllBadges:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /badges
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetEarnedBadges:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /badges/earned
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  #############################################
  # Grammar Lambda Functions
  #############################################

  GrammarFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-grammar-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.GrammarHandler::handleRequest
      Description: Handle grammar check using Bedrock AI
      Timeout: 60
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - comprehend:DetectSentiment
                - comprehend:DetectSyntax
                - comprehend:DetectKeyPhrases
                - comprehend:DetectDominantLanguage
              Resource: "*"
      Events:
        GrammarCheck:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/check
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GrammarConversation:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/conversation
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetSessions:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/sessions
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetSessionDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/sessions/{sessionId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/sessions/{sessionId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  #############################################
  # Grammar WebSocket API (Streaming)
  #############################################

  GrammarWebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: group2-englishstudy-grammar-websocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  GrammarWebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      StageName: dev
      AutoDeploy: true

  # Grammar WebSocket Connect Route
  GrammarConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub integrations/${GrammarConnectIntegration}

  GrammarConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GrammarStreamingConnectFunction.Arn}/invocations

  # Grammar WebSocket Disconnect Route
  GrammarDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub integrations/${GrammarDisconnectIntegration}

  GrammarDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GrammarStreamingDisconnectFunction.Arn}/invocations

  # Grammar WebSocket Streaming Route
  GrammarStreamingRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      RouteKey: grammarStreaming
      AuthorizationType: NONE
      Target: !Sub integrations/${GrammarStreamingIntegration}

  GrammarStreamingIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GrammarStreamingFunction.Arn}/invocations

  # Grammar WebSocket Lambda Functions
  GrammarStreamingConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-grammar-ws-connect
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.websocket.GrammarStreamingConnectHandler::handleRequest
      Description: Handle Grammar WebSocket $connect with JWT auth
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable

  GrammarStreamingConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GrammarStreamingConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*/$connect

  GrammarStreamingDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-grammar-ws-disconnect
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.websocket.GrammarStreamingDisconnectHandler::handleRequest
      Description: Handle Grammar WebSocket $disconnect
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable

  GrammarStreamingDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GrammarStreamingDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*/$disconnect

  GrammarStreamingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-grammar-ws-streaming
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.websocket.GrammarStreamingHandler::handleRequest
      Description: Handle Grammar streaming with Bedrock
      Timeout: 120
      MemorySize: 1024
      Environment:
        Variables:
          GRAMMAR_WEBSOCKET_ENDPOINT: !Sub "https://${GrammarWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*

  GrammarStreamingPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GrammarStreamingFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*/grammarStreaming

  # EventBridge Scheduler - 매일 자정 단어 학습 통계 집계
  ScheduledStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-scheduled-stats
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.stats.handler.ScheduledStatsHandler::handleRequest
      Description: Daily scheduled job for word learning stats aggregation
      Timeout: 300
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 15 * * ? *)  # UTC 15:00 = KST 00:00 (자정)
            Name: daily-stats-aggregation
            Description: Daily word learning stats aggregation
            Enabled: true

  #############################################
  # OPIc Lambda Functions
  #############################################

  OPIcSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-opic-session-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.opic.handler.OPIcSessionHandler::handleRequest
      Description: Handle OPIc speaking practice sessions
      Timeout: 180
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TRANSCRIBE_API_KEY: "/opic/transcribe-proxy-api-key"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref OPIcTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
        # Parameter Store 읽기 권한 추가
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/opic/*"
      Events:
        # 세션 생성
        CreateSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        # 세션 조회
        GetSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        # 세션 목록 조회
        GetSessions:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        # 다음 질문 조회
        GetNextQuestion:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/questions/next
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        # 답변 제출
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/answers
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        # 세션 완료
        CompleteSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/complete
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        # 음성 업로드 Presigned URL
        GetUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/upload-url
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  #############################################
  # DynamoDB Tables
  #############################################

  UserTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    # UpdateReplacePolicy: Retain
    Properties:
      TableName: group2-englishstudy-user
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S

      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  ChatTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-chat
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  VocabTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-vocab
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  OPIcTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-opic
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  #############################################
  # SNS / SQS for Async Statistics Processing
  #############################################

  # SNS Topic - 시험 결과 이벤트 발행
  TestResultTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: group2-englishstudy-test-result-topic

  # SQS Dead Letter Queue - 실패한 메시지 보관
  StatisticsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: group2-englishstudy-statistics-dlq
      MessageRetentionPeriod: 1209600  # 14일

  # SQS Queue - 통계 처리용
  StatisticsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: group2-englishstudy-statistics-queue
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt StatisticsDeadLetterQueue.Arn
        maxReceiveCount: 3

  # SQS Queue Policy - SNS에서 메시지 수신 허용
  StatisticsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref StatisticsQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt StatisticsQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref TestResultTopic

  # SNS → SQS 구독
  StatisticsQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref TestResultTopic
      Endpoint: !GetAtt StatisticsQueue.Arn
      RawMessageDelivery: true

  # Statistics Processor Lambda - SQS에서 메시지 소비하여 통계 업데이트
  StatisticsProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-statistics-processor
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatisticsHandler::handleRequest
      Description: Process test results and update user word statistics
      Timeout: 60
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SQSPollerPolicy:
            QueueName: !GetAtt StatisticsQueue.QueueName
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt StatisticsQueue.Arn
            BatchSize: 10

#############################################
# Outputs
#############################################

Outputs:
  ApiUrl:
    Description: Unified API Gateway endpoint URL
    Value: !Sub 'https://${MainApi}.execute-api.${AWS::Region}.amazonaws.com/dev/'

  WebSocketUrl:
    Description: WebSocket API Gateway endpoint URL
    Value: !Sub 'wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev'

  GrammarWebSocketUrl:
    Description: Grammar Streaming WebSocket API endpoint URL
    Value: !Sub 'wss://${GrammarWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev'

  ChatTableName:
    Description: Chat DynamoDB Table Name
    Value: !Ref ChatTable

  VocabTableName:
    Description: Vocab DynamoDB Table Name
    Value: !Ref VocabTable

  BucketName:
    Description: S3 Bucket Name
    Value: group2-englishstudy

  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool

  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient

  OPIcTableName:
    Description: OPIc DynamoDB Table Name
    Value: !Ref OPIcTable
