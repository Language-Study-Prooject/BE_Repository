AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Group2 English Study - Unified API (Chatting + Vocabulary)

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: java21
    Architectures:
      - x86_64
    Environment:
      Variables:
        USER_TABLE_NAME: !Ref UserTable
        CHAT_TABLE_NAME: !Ref ChatTable
        VOCAB_TABLE_NAME: !Ref VocabTable
        CHAT_BUCKET_NAME: group2-englishstudy
        VOCAB_BUCKET_NAME: group2-englishstudy
        AWS_REGION_NAME: !Ref AWS::Region
        ROOM_TOKEN_TTL_SECONDS: "300"

Resources:
  #############################################
  # Cognito User Pool
  #############################################

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-userpool"
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: false
      # Cognito에 저장할 사용자 정보 정의 ≈ 회원 테이블 컬럼
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: nickname
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: level
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: profileUrl
          AttributeDataType: String
          Required: false
          Mutable: true
      LambdaConfig:
        PreSignUp: !GetAtt PreSignUpFunction.Arn

  # Cognito에게 Lambda 호출 권한 부여
  PreSignUpPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref PreSignUpFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*

  # TODO : 회원가입 시 기본값 자동 설정 handler 추가
  # 사용자 custom 속성들 기본값 설정 Lambda 함수
  PreSignUpFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-pre-signup"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.PreSignUpHandler::handleRequest
      Description: Set default values for new users (nickname, level, picture)
      MemorySize: 256
      Timeout: 10
      Environment:
        Variables:
          DEFAULT_PROFILE_URL: https://group2-englishstudy.s3.amazonaws.com/profile/default.png

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${AWS::StackName}-client"
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
      PreventUserExistenceErrors: ENABLED

  #############################################
  # API Gateway (Unified)
  #############################################

  MainApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: group2-englishstudy-api
      StageName: dev
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
        AllowOrigin: "'*'"

      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt CognitoUserPool.Arn
            Identity:
              Header: Authorization

  #############################################
  # WebSocket API Gateway
  #############################################

  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: group2-englishstudy-websocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref WebSocketApi
      StageName: dev
      AutoDeploy: true

  # WebSocket Connect Route
  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub integrations/${ConnectIntegration}

  ConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations

  # WebSocket Disconnect Route
  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub integrations/${DisconnectIntegration}

  DisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations

  # WebSocket SendMessage Route
  SendMessageRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: sendMessage
      AuthorizationType: NONE
      Target: !Sub integrations/${SendMessageIntegration}

  SendMessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketMessageFunction.Arn}/invocations

  #############################################
  # WebSocket Lambda Functions
  #############################################

  WebSocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-ws-connect
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketConnectHandler::handleRequest
      Description: Handle WebSocket $connect
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_CONNECTION_TTL_SECONDS: "600"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable

  WebSocketConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$connect

  WebSocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-ws-disconnect
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketDisconnectHandler::handleRequest
      Description: Handle WebSocket $disconnect
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable

  WebSocketDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$disconnect

  WebSocketMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-ws-message
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketMessageHandler::handleRequest
      Description: Handle WebSocket sendMessage
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*

  WebSocketMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketMessageFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/sendMessage

  #############################################
  # Chatting Lambda Functions
  #############################################

  ChatRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-room-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatRoomHandler::handleRequest
      Description: Handle chat room CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
      Events:
        CreateRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetRooms:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        DeleteRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: DELETE
            # Auth:
            #   Authorizer: CognitoAuthorizer
        JoinRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/join
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        LeaveRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/leave
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer

  ChatMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-message-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatMessageHandler::handleRequest
      Description: Handle chat messages
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetMessages:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages/{messageId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer

  ChatAIFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-ai-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatAIHandler::handleRequest
      Description: Generate AI responses using Bedrock
      Timeout: 60
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
      Events:
        GenerateAI:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/ai/generate
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer

  ChatVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-chat-voice-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatVoiceHandler::handleRequest
      Description: Convert text to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/voice/synthesize
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer

  #############################################
  # Vocabulary Lambda Functions
  #############################################

  WordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-word-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordHandler::handleRequest
      Description: Handle word CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        BatchCreateWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        BatchGetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch/get
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        SearchWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/search
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        UpdateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: PUT
            # Auth:
            #   Authorizer: CognitoAuthorizer
        DeleteWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: DELETE
            # Auth:
            #   Authorizer: CognitoAuthorizer

  UserWordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-userword-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.UserWordHandler::handleRequest
      Description: Handle user word learning status
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetWrongAnswers:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/wrong-answers
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetUserWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words/{wordId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        UpdateUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words/{wordId}
            Method: PUT
            # Auth:
            #   Authorizer: CognitoAuthorizer
        UpdateUserWordTag:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/words/{wordId}/tag
            Method: PUT
            # Auth:
            #   Authorizer: CognitoAuthorizer

  WordGroupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-wordgroup-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordGroupHandler::handleRequest
      Description: Handle user custom word groups
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetGroups:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetGroupDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups/{groupId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        UpdateGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups/{groupId}
            Method: PUT
            # Auth:
            #   Authorizer: CognitoAuthorizer
        DeleteGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups/{groupId}
            Method: DELETE
            # Auth:
            #   Authorizer: CognitoAuthorizer
        AddWordToGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups/{groupId}/words/{wordId}
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        RemoveWordFromGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/users/{userId}/groups/{groupId}/words/{wordId}
            Method: DELETE
            # Auth:
            #   Authorizer: CognitoAuthorizer

  DailyStudyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-daily-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.DailyStudyHandler::handleRequest
      Description: Handle daily study word assignment
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetDailyWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily/{userId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        MarkWordLearned:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily/{userId}/words/{wordId}/learned
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer

  TestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-test-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.TestHandler::handleRequest
      Description: Handle vocabulary tests
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TEST_RESULT_TOPIC_ARN: !Ref TestResultTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt TestResultTopic.TopicName
      Events:
        StartTest:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/start
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/submit
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetTestResults:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/results
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetTestResultDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/{userId}/results/{testId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer

  StatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-stats-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatsHandler::handleRequest
      Description: Handle user learning statistics
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/{userId}
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetDailyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/{userId}/daily
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer
        GetWeaknessAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/{userId}/weakness
            Method: GET
            # Auth:
            #   Authorizer: CognitoAuthorizer

  VocabVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-vocab-voice-handler
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.VoiceHandler::handleRequest
      Description: Convert word to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3CrudPolicy:
            BucketName: group2-englishstudy
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/voice/synthesize
            Method: POST
            # Auth:
            #   Authorizer: CognitoAuthorizer

  #############################################
  # DynamoDB Tables
  #############################################

  UserTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-user
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S

      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  ChatTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-chat
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  VocabTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: group2-englishstudy-vocab
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  #############################################
  # SNS / SQS for Async Statistics Processing
  #############################################

  # SNS Topic - 시험 결과 이벤트 발행
  TestResultTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: group2-englishstudy-test-result-topic

  # SQS Dead Letter Queue - 실패한 메시지 보관
  StatisticsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: group2-englishstudy-statistics-dlq
      MessageRetentionPeriod: 1209600  # 14일

  # SQS Queue - 통계 처리용
  StatisticsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: group2-englishstudy-statistics-queue
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt StatisticsDeadLetterQueue.Arn
        maxReceiveCount: 3

  # SQS Queue Policy - SNS에서 메시지 수신 허용
  StatisticsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref StatisticsQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt StatisticsQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref TestResultTopic

  # SNS → SQS 구독
  StatisticsQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref TestResultTopic
      Endpoint: !GetAtt StatisticsQueue.Arn
      RawMessageDelivery: true

  # Statistics Processor Lambda - SQS에서 메시지 소비하여 통계 업데이트
  StatisticsProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: group2-englishstudy-statistics-processor
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatisticsHandler::handleRequest
      Description: Process test results and update user word statistics
      Timeout: 60
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SQSPollerPolicy:
            QueueName: !GetAtt StatisticsQueue.QueueName
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt StatisticsQueue.Arn
            BatchSize: 10

#############################################
# Outputs
#############################################

Outputs:
  ApiUrl:
    Description: Unified API Gateway endpoint URL
    Value: !Sub 'https://${MainApi}.execute-api.${AWS::Region}.amazonaws.com/dev/'

  WebSocketUrl:
    Description: WebSocket API Gateway endpoint URL
    Value: !Sub 'wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/dev'

  ChatTableName:
    Description: Chat DynamoDB Table Name
    Value: !Ref ChatTable

  VocabTableName:
    Description: Vocab DynamoDB Table Name
    Value: !Ref VocabTable

  BucketName:
    Description: S3 Bucket Name
    Value: group2-englishstudy

  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool

  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient
