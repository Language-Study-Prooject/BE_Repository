AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Group2 English Study - Unified API (Chatting + Vocabulary)

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - test
      - prod
    Description: Deployment environment

  ExistingCognitoUserPoolId:
    Type: String
    Default: ""
    Description: Existing Cognito User Pool ID (leave empty to create new)

  ExistingCognitoClientId:
    Type: String
    Default: ""
    Description: Existing Cognito User Pool Client ID

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: java21
    Architectures:
      - x86_64
    Tracing: Active
    AutoPublishAlias: live
    Environment:
      Variables:
        USER_TABLE_NAME: !Ref UserTable
        CHAT_TABLE_NAME: !Ref ChatTable
        VOCAB_TABLE_NAME: !Ref VocabTable
        OPIC_TABLE_NAME: !Ref OPIcTable
        NEWS_TABLE_NAME: !Ref NewsTable
        SPEAKING_TABLE_NAME: !Ref SpeakingTable
        BUCKET_NAME: !Sub "${AWS::StackName}"
        CHAT_BUCKET_NAME: !Sub "${AWS::StackName}"
        VOCAB_BUCKET_NAME: !Sub "${AWS::StackName}"
        PROFILE_BUCKET_NAME: !Sub "${AWS::StackName}"
        OPIC_BUCKET_NAME: !Sub "${AWS::StackName}"
        NEWS_BUCKET_NAME: !Sub "${AWS::StackName}"
        SPEAKING_BUCKET_NAME: !Sub "${AWS::StackName}"
        AWS_REGION_NAME: !Ref AWS::Region
        ROOM_TOKEN_TTL_SECONDS: "300"
        TRANSCRIBE_PROXY_URL: "https://tfo1zm7vec.execute-api.ap-northeast-2.amazonaws.com/prod/transcribe"
  Api:
    TracingEnabled: true

Resources:
  #############################################
  # Cognito - Using Existing User Pool
  # (Cognito resources are managed in group2-englishstudy-chatting stack)
  #############################################

  # 사용자 custom 속성들 기본값 설정 Lambda 함수
  PreSignUpFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-pre-signup"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.PreSignUpHandler::handleRequest
      Description: Set default values for new users (nickname, level, picture)
      MemorySize: 256
      Timeout: 10
      Environment:
        Variables:
          DEFAULT_PROFILE_URL: !Sub "https://${AWS::StackName}.s3.amazonaws.com/profile/default.png"

  # 회원가입 시점에 사용자 모든 정보가 DB에 저장 Lambda 함수
  PostConfirmationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-post-confirmation"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.PostConfirmationHandler::handleRequest
      Description: Handle user registration - save to DynamoDB
      MemorySize: 1024
      Timeout: 5
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserTable

  #############################################
  # API Gateway (Unified)
  #############################################

  MainApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${AWS::StackName}-api"
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Requested-With,Accept'"
        AllowOrigin: "'*'"
        AllowCredentials: false
      GatewayResponses:
        UNAUTHORIZED:
          StatusCode: 401
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
          ResponseTemplates:
            application/json: '{"message": "Unauthorized", "statusCode": 401}'
        ACCESS_DENIED:
          StatusCode: 403
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
          ResponseTemplates:
            application/json: '{"message": "Access Denied", "statusCode": 403}'
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        EXPIRED_TOKEN:
          StatusCode: 401
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
          ResponseTemplates:
            application/json: '{"message": "Token expired", "statusCode": 401}'
      Auth:
        DefaultAuthorizer: CognitoAuthV2
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          CognitoAuthV2:
            UserPoolArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${ExistingCognitoUserPoolId}"
            Identity:
              Header: Authorization

  #############################################
  # WebSocket API Gateway
  #############################################

  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${AWS::StackName}-websocket"
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref WebSocketApi
      StageName: !Ref Environment
      AutoDeploy: true

  # WebSocket Connect Route
  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub integrations/${ConnectIntegration}

  ConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations

  # WebSocket Disconnect Route
  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub integrations/${DisconnectIntegration}

  DisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations

  # WebSocket SendMessage Route
  SendMessageRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: sendMessage
      AuthorizationType: NONE
      Target: !Sub integrations/${SendMessageIntegration}

  SendMessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketMessageFunction.Arn}/invocations

  #############################################
  # WebSocket Lambda Functions
  #############################################

  WebSocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-ws-connect"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketConnectHandler::handleRequest
      Description: Handle WebSocket $connect
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_CONNECTION_TTL_SECONDS: "600"
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*

  WebSocketConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$connect

  WebSocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-ws-disconnect"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketDisconnectHandler::handleRequest
      Description: Handle WebSocket $disconnect
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*

  WebSocketDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$disconnect

  WebSocketMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-ws-message"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.websocket.WebSocketMessageHandler::handleRequest
      Description: Handle WebSocket sendMessage
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
          GAME_AUTO_CLOSE_LAMBDA_ARN: !GetAtt GameAutoCloseFunction.Arn
          SCHEDULER_ROLE_ARN: !GetAtt GameSchedulerRole.Arn
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - DynamoDBReadPolicy:
            TableName: !Ref UserTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
        # EventBridge Scheduler 권한
        - Statement:
            - Effect: Allow
              Action:
                - scheduler:CreateSchedule
                - scheduler:DeleteSchedule
                - scheduler:GetSchedule
              Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/${AWS::StackName}-game-auto-close/*"
        - Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt GameSchedulerRole.Arn
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName

  WebSocketMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketMessageFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/sendMessage

  #############################################
  # User Lambda Functions
  #############################################

  UserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-user-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.user.handler.UserHandler::handleRequest
      Description: Handle user profile CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
      Events:
        GetMyProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /users/profile/me
            Method: GET
        UpdateMyProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /users/profile/me
            Method: PUT
        UploadProfileImage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /users/profile/me/image
            Method: POST

  #############################################
  # Chatting Lambda Functions
  #############################################

  ChatRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-chat-room-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatRoomHandler::handleRequest
      Description: Handle chat room CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - DynamoDBReadPolicy:
            TableName: !Ref UserTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
      Events:
        CreateRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetRooms:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        DeleteRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthV2
        JoinRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/join
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        LeaveRoom:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/leave
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2

  GameFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-game-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.GameHandler::handleRequest
      Description: Handle catch-mind game operations
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
          GAME_AUTO_CLOSE_LAMBDA_ARN: !GetAtt GameAutoCloseFunction.Arn
          SCHEDULER_ROLE_ARN: !GetAtt GameSchedulerRole.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - DynamoDBReadPolicy:
            TableName: !Ref VocabTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"
        # EventBridge Scheduler 권한
        - Statement:
            - Effect: Allow
              Action:
                - scheduler:CreateSchedule
                - scheduler:DeleteSchedule
                - scheduler:GetSchedule
              Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/${AWS::StackName}-game-auto-close/*"
        - Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt GameSchedulerRole.Arn
      Events:
        StartGame:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/start
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        StopGame:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/stop
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetGameStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/status
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetScores:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/game/scores
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  # 끝말잇기(Word Chain) 게임 핸들러
  WordChainFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-wordchain-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.WordChainHandler::handleRequest
      Description: Handle word chain game operations
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - DynamoDBReadPolicy:
            TableName: !Ref UserTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"
      Events:
        StartWordChain:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/wordchain/start
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        SubmitWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/wordchain/submit
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        HandleTimeout:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/wordchain/timeout
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        StopWordChain:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/wordchain/stop
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetWordChainStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/wordchain/status
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  # 게임 자동 종료 Lambda (EventBridge Scheduler에 의해 호출)
  GameAutoCloseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-game-auto-close"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.GameAutoCloseHandler::handleRequest
      Description: Auto-close game after 7 minutes
      Timeout: 30
      MemorySize: 512
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

  # EventBridge Scheduler가 Lambda를 호출할 수 있는 IAM Role
  GameSchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-game-scheduler-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeGameAutoCloseLambda
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt GameAutoCloseFunction.Arn

  # EventBridge Schedule Group
  GameScheduleGroup:
    Type: AWS::Scheduler::ScheduleGroup
    Properties:
      Name: !Sub "${AWS::StackName}-game-auto-close"

  ChatMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-chat-message-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatMessageHandler::handleRequest
      Description: Handle chat messages
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetMessages:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetMessage:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/rooms/{roomId}/messages/{messageId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  ChatVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-chat-voice-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.chatting.handler.ChatVoiceHandler::handleRequest
      Description: Convert text to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /chat/voice/synthesize
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2

  #############################################
  # Vocabulary Lambda Functions
  #############################################

  WordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-word-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordHandler::handleRequest
      Description: Handle word CRUD operations
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: POST
            Auth:
              Authorizer: NONE
        BatchCreateWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch
            Method: POST
            Auth:
              Authorizer: NONE
        BatchGetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/batch/get
            Method: POST
            Auth:
              Authorizer: NONE
        SearchWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/search
            Method: GET
            Auth:
              Authorizer: NONE
        GetWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words
            Method: GET
            Auth:
              Authorizer: NONE
        GetWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: GET
            Auth:
              Authorizer: NONE
        UpdateWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: PUT
            Auth:
              Authorizer: NONE
        DeleteWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/words/{wordId}
            Method: DELETE
            Auth:
              Authorizer: NONE

  UserWordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-userword-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.UserWordHandler::handleRequest
      Description: Handle user word learning status
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetWrongAnswers:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/wrong-answers
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetUserWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        UpdateUserWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthV2
        UpdateUserWordTag:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}/tag
            Method: PATCH
            Auth:
              Authorizer: CognitoAuthV2
        UpdateUserWordStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/user-words/{wordId}/status
            Method: PATCH
            Auth:
              Authorizer: CognitoAuthV2

  WordGroupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-wordgroup-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.WordGroupHandler::handleRequest
      Description: Handle user custom word groups
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        CreateGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetGroups:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetGroupDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        UpdateGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthV2
        DeleteGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthV2
        AddWordToGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}/words/{wordId}
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        RemoveWordFromGroup:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/groups/{groupId}/words/{wordId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthV2

  DailyStudyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-daily-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.DailyStudyHandler::handleRequest
      Description: Handle daily study word assignment
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        GetDailyWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        MarkWordLearned:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/daily/words/{wordId}/learned
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2

  TestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-test-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.TestHandler::handleRequest
      Description: Handle vocabulary tests
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TEST_RESULT_TOPIC_ARN: !Ref TestResultTopic
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt TestResultTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        StartTest:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/start
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/submit
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetTestResults:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/results
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetTestResultDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/results/{testId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetTestedWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/test/tested-words
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  StatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-stats-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatsHandler::handleRequest
      Description: Handle user learning statistics
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetDailyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/daily
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetWeaknessAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/stats/weakness
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  VocabVoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-vocab-voice-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.VoiceHandler::handleRequest
      Description: Convert word to speech using Polly
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
      Events:
        TextToSpeech:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /vocab/voice/synthesize
            Method: POST
            Auth:
              Authorizer: NONE

  #############################################
  # Stats Lambda Functions (DynamoDB Streams)
  #############################################

  # DynamoDB Streams 트리거 - 테스트 결과 저장 시 통계 자동 업데이트
  StatsStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-stats-stream-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.stats.handler.StatsStreamHandler::handleRequest
      Description: Process DynamoDB Streams for stats aggregation
      Timeout: 60
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt VocabTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 100
            FilterCriteria:
              Filters:
                - Pattern: '{"eventName": ["INSERT"], "dynamodb": {"NewImage": {"PK": {"S": [{"prefix": "TEST#"}]}}}}'

  # 사용자 통계 조회 API Handler
  UserStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-user-stats-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.stats.handler.UserStatsHandler::handleRequest
      Description: Handle user learning statistics API
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        GetDailyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/daily
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetWeeklyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/weekly
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetMonthlyStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/monthly
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetTotalStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/total
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetDashboard:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/dashboard
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetStatsHistory:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /stats/history
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  # Badge Lambda Function
  BadgeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-badge-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.badge.handler.BadgeHandler::handleRequest
      Description: Handle user badges and achievements
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3ReadPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        GetAllBadges:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /badges
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetEarnedBadges:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /badges/earned
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  #############################################
  # Grammar Lambda Functions
  #############################################

  GrammarFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-grammar-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.GrammarHandler::handleRequest
      Description: Handle grammar check using Bedrock AI
      Timeout: 60
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - comprehend:DetectSentiment
                - comprehend:DetectSyntax
                - comprehend:DetectKeyPhrases
                - comprehend:DetectDominantLanguage
              Resource: "*"
      Events:
        GrammarCheck:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/check
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GrammarConversation:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/conversation
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        GetSessions:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/sessions
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        GetSessionDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/sessions/{sessionId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        DeleteSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /grammar/sessions/{sessionId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthV2

  #############################################
  # Grammar WebSocket API (Streaming)
  #############################################

  GrammarWebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${AWS::StackName}-grammar-websocket"
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  GrammarWebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      StageName: !Ref Environment
      AutoDeploy: true

  # Grammar WebSocket Connect Route
  GrammarConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub integrations/${GrammarConnectIntegration}

  GrammarConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GrammarStreamingConnectFunction.Arn}/invocations

  # Grammar WebSocket Disconnect Route
  GrammarDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub integrations/${GrammarDisconnectIntegration}

  GrammarDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GrammarStreamingDisconnectFunction.Arn}/invocations

  # Grammar WebSocket Streaming Route
  GrammarStreamingRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      RouteKey: grammarStreaming
      AuthorizationType: NONE
      Target: !Sub integrations/${GrammarStreamingIntegration}

  GrammarStreamingIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref GrammarWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GrammarStreamingFunction.Arn}/invocations

  # Grammar WebSocket Lambda Functions
  GrammarStreamingConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-grammar-ws-connect"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.websocket.GrammarStreamingConnectHandler::handleRequest
      Description: Handle Grammar WebSocket $connect with JWT auth
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${GrammarWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*

  GrammarStreamingConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GrammarStreamingConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*/$connect

  GrammarStreamingDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-grammar-ws-disconnect"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.websocket.GrammarStreamingDisconnectHandler::handleRequest
      Description: Handle Grammar WebSocket $disconnect
      Environment:
        Variables:
          WEBSOCKET_ENDPOINT: !Sub "https://${GrammarWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*

  GrammarStreamingDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GrammarStreamingDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*/$disconnect

  GrammarStreamingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-grammar-ws-streaming"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.grammar.handler.websocket.GrammarStreamingHandler::handleRequest
      Description: Handle Grammar streaming with Bedrock
      Timeout: 120
      MemorySize: 1024
      Environment:
        Variables:
          GRAMMAR_WEBSOCKET_ENDPOINT: !Sub "https://${GrammarWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*

  GrammarStreamingPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GrammarStreamingFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GrammarWebSocketApi}/*/grammarStreaming

  # EventBridge Scheduler - 연속 학습 리마인더 (매일 21시 KST)
  StreakReminderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-streak-reminder"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.notification.handler.StreakReminderHandler::handleRequest
      Description: Daily streak reminder for users who haven't studied today
      Timeout: 120
      MemorySize: 512
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref VocabTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 12 * * ? *)  # UTC 12:00 = KST 21:00
            Name: !Sub "${AWS::StackName}-streak-reminder-schedule"
            Description: Daily streak reminder at 21:00 KST
            Enabled: true

  # EventBridge Scheduler - 매일 자정 단어 학습 통계 집계
  ScheduledStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-scheduled-stats"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.stats.handler.ScheduledStatsHandler::handleRequest
      Description: Daily scheduled job for word learning stats aggregation
      Timeout: 300
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 15 * * ? *)  # UTC 15:00 = KST 00:00 (자정)
            Name: !Sub "${AWS::StackName}-daily-stats-aggregation"
            Description: Daily word learning stats aggregation
            Enabled: true

  #############################################
  # OPIc Lambda Functions
  #############################################

  OPIcSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-opic-session-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.opic.handler.OPIcSessionHandler::handleRequest
      Description: Handle OPIc speaking practice sessions
      Timeout: 180
      MemorySize: 1024
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TRANSCRIBE_API_KEY: "/opic/transcribe-proxy-api-key"
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref OPIcTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
                - polly:DescribeVoices
              Resource: "*"
        # Parameter Store 읽기 권한 추가
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/opic/*"
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        # 세션 생성
        CreateSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        # 세션 조회
        GetSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        # 세션 목록 조회
        GetSessions:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        # 다음 질문 조회
        GetNextQuestion:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/questions/next
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2
        # 답변 제출
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/answers
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        # 세션 완료
        CompleteSession:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/complete
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        # 음성 업로드 Presigned URL
        GetUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /opic/sessions/{sessionId}/upload-url
            Method: GET
            Auth:
              Authorizer: CognitoAuthV2

  #############################################
  # Speaking Lambda Functions
  #############################################

  SpeakingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-speaking-handler"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.speaking.handler.SpeakingHandler::handleRequest
      Description: Handle speaking chat API
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          TRANSCRIBE_API_KEY: "/opic/transcribe-proxy-api-key"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SpeakingTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/opic/*"
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - polly:SynthesizeSpeech
              Resource: "*"
      Events:
        SpeakingChat:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /speaking/chat
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2
        SpeakingReset:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /speaking/reset
            Method: POST
            Auth:
              Authorizer: CognitoAuthV2

  #############################################
  # DynamoDB Tables
  #############################################

  UserTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    # UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "${AWS::StackName}-user"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S

      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  ChatTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-chat"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  VocabTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-vocab"
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  OPIcTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-opic"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  #############################################
  # News Collection Scheduled Lambda
  #############################################

  NewsCollectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-news-collection"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.news.handler.NewsCollectionHandler::handleRequest
      Description: 매일 18시에 영어 뉴스를 수집하는 Lambda
      MemorySize: 512
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref NewsTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 * * ? *)
            Name: !Sub "${AWS::StackName}-news-collection-daily-schedule"
            Description: 매일 18시 KST (09:00 UTC)에 뉴스 수집
            Enabled: true

  NewsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-news"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.news.handler.NewsHandler::handleRequest
      Description: 뉴스 학습 API
      MemorySize: 256
      Timeout: 30
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref NewsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - S3CrudPolicy:
            BucketName: !Sub "${AWS::StackName}"
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
        - Statement:
            - Effect: Allow
              Action:
                - polly:SynthesizeSpeech
              Resource: "*"
      Events:
        GetNewsList:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news
            Method: GET
        GetTodayNews:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/today
            Method: GET
        GetRecommendedNews:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/recommended
            Method: GET
        GetNewsStats:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/stats
            Method: GET
        GetBookmarks:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/bookmarks
            Method: GET
        GetUserWords:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/words
            Method: GET
        SyncWordToVocab:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/words/{word}/sync
            Method: POST
        CollectWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/words
            Method: POST
        DeleteWord:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/words/{word}
            Method: DELETE
        GetWordDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/words/{word}
            Method: GET
        GetQuizHistory:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/quiz/history
            Method: GET
        GetQuiz:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/quiz
            Method: GET
        SubmitQuiz:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/quiz
            Method: POST
        MarkAsRead:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/read
            Method: POST
        ToggleBookmark:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/bookmark
            Method: POST
        GetAudio:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}/audio
            Method: GET
        GetNewsDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MainApi
            Path: /news/{articleId}
            Method: GET

  NewsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-news"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  SpeakingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-speaking"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  #############################################
  # S3 Bucket for Content Storage
  #############################################

  ContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}"
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedOrigins:
              - "*"
            MaxAge: 3600
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  #############################################
  # SNS / SQS for Async Statistics Processing
  #############################################

  # SNS Topic - 시험 결과 이벤트 발행
  TestResultTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${AWS::StackName}-test-result-topic"

  # SQS Dead Letter Queue - 실패한 메시지 보관
  StatisticsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-statistics-dlq"
      MessageRetentionPeriod: 1209600  # 14일

  # SQS Queue - 통계 처리용
  StatisticsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-statistics-queue"
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt StatisticsDeadLetterQueue.Arn
        maxReceiveCount: 3

  # SQS Queue Policy - SNS에서 메시지 수신 허용
  StatisticsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref StatisticsQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt StatisticsQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref TestResultTopic

  # SNS → SQS 구독
  StatisticsQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref TestResultTopic
      Endpoint: !GetAtt StatisticsQueue.Arn
      RawMessageDelivery: true

  #############################################
  # SNS / SQS for Real-time Notifications (SSE)
  #############################################

  # SNS Topic - 알림 이벤트 발행 (배지, 학습완료, 테스트결과 등)
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${AWS::StackName}-notification-topic"

  # SQS Dead Letter Queue - 실패한 알림 메시지 보관
  NotificationDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-notification-dlq"
      MessageRetentionPeriod: 1209600  # 14일

  # SQS Queue - SSE 알림 처리용
  NotificationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-notification-queue"
      VisibilityTimeout: 30
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt NotificationDeadLetterQueue.Arn
        maxReceiveCount: 3

  # SQS Queue Policy - SNS에서 메시지 수신 허용
  NotificationQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref NotificationQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt NotificationQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref NotificationTopic

  # SNS → SQS 구독
  NotificationQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref NotificationTopic
      Endpoint: !GetAtt NotificationQueue.Arn
      RawMessageDelivery: true

  # Statistics Processor Lambda - SQS에서 메시지 소비하여 통계 업데이트
  StatisticsProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-statistics-processor"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.vocabulary.handler.StatisticsHandler::handleRequest
      Description: Process test results and update user word statistics
      Timeout: 60
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref VocabTable
        - SQSPollerPolicy:
            QueueName: !GetAtt StatisticsQueue.QueueName
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt StatisticsQueue.Arn
            BatchSize: 10

  #############################################
  # Notification SSE Lambda (Function URL + Response Streaming)
  #############################################

  # SSE 알림 스트리밍 Lambda - Function URL with Response Streaming
  NotificationStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-notification-stream"
      CodeUri: .
      Handler: com.mzc.secondproject.serverless.domain.notification.handler.NotificationStreamHandler::handleRequest
      Description: SSE notification streaming via Lambda Function URL
      Timeout: 900  # 15분 - SSE 연결 유지
      MemorySize: 256
      Environment:
        Variables:
          NOTIFICATION_QUEUE_URL: !Ref NotificationQueue
      Policies:
        - SQSPollerPolicy:
            QueueName: !GetAtt NotificationQueue.QueueName
      FunctionUrlConfig:
        AuthType: NONE
        InvokeMode: RESPONSE_STREAM
        Cors:
          AllowCredentials: false
          AllowHeaders:
            - "*"
          AllowMethods:
            - GET
          AllowOrigins:
            - "*"

#############################################
# Outputs
#############################################

Outputs:
  ApiUrl:
    Description: Unified API Gateway endpoint URL
    Value: !Sub 'https://${MainApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/'

  WebSocketUrl:
    Description: WebSocket API Gateway endpoint URL
    Value: !Sub 'wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'

  GrammarWebSocketUrl:
    Description: Grammar Streaming WebSocket API endpoint URL
    Value: !Sub 'wss://${GrammarWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'

  ChatTableName:
    Description: Chat DynamoDB Table Name
    Value: !Ref ChatTable

  VocabTableName:
    Description: Vocab DynamoDB Table Name
    Value: !Ref VocabTable

  BucketName:
    Description: S3 Bucket Name
    Value: !Ref ContentBucket

  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref ExistingCognitoUserPoolId

  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref ExistingCognitoClientId

  OPIcTableName:
    Description: OPIc DynamoDB Table Name
    Value: !Ref OPIcTable

  SpeakingTableName:
    Description: Speaking DynamoDB Table Name
    Value: !Ref SpeakingTable

  NotificationStreamUrl:
    Description: Notification SSE Stream Function URL
    Value: !GetAtt NotificationStreamFunctionUrl.FunctionUrl

  NotificationTopicArn:
    Description: Notification SNS Topic ARN
    Value: !Ref NotificationTopic
