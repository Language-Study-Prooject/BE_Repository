# GitHub Issue → Jira 동기화
name: Issue-Jira Sync

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]

env:
  JIRA_PROJECT_KEY: MESP

jobs:
  # GitHub Issue 생성 → Jira 티켓 생성
  create-jira-from-issue:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: Determine Issue Type from Title
        id: issue-type
        run: |
          TITLE='${{ github.event.issue.title }}'
          
          # Issue 제목 기반 Jira 타입 매핑
          # [EPIC], [STORY], [TASK] 3가지
          if echo "$TITLE" | grep -qiE "^\[EPIC\]"; then
            echo "type=Epic" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE "^\[STORY\]"; then
            echo "type=Story" >> $GITHUB_OUTPUT
          else
            echo "type=Task" >> $GITHUB_OUTPUT
          fi

      - name: Create Jira Issue
        id: create-jira
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue" \
            -d '{
              "fields": {
                "project": {"key": "${{ env.JIRA_PROJECT_KEY }}"},
                "summary": "[GH-#${{ github.event.issue.number }}] ${{ github.event.issue.title }}",
                "description": {
                  "type": "doc",
                  "version": 1,
                  "content": [
                    {"type": "paragraph", "content": [{"type": "text", "text": "GitHub Issue: ${{ github.event.issue.html_url }}"}]},
                    {"type": "paragraph", "content": [{"type": "text", "text": "Author: ${{ github.event.issue.user.login }}"}]}
                  ]
                },
                "issuetype": {"name": "${{ steps.issue-type.outputs.type }}"}
              }
            }')
          
          JIRA_KEY=$(echo "$RESPONSE" | jq -r '.key // empty')
          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT

      - name: Update GitHub Issue with Jira Link
        if: steps.create-jira.outputs.jira_key != ''
        uses: actions/github-script@v7
        with:
          script: |
            const jiraKey = '${{ steps.create-jira.outputs.jira_key }}';
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}/browse/' + jiraKey;
            const currentBody = context.payload.issue.body || '';
            const newBody = `\n---\n**Jira:** [${jiraKey}](${jiraUrl})\n---\n` + currentBody;
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: newBody
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Jira 티켓 생성: [${jiraKey}](${jiraUrl})`
            });

  # GitHub Issue 닫힘 → Jira 티켓 Done
  close-jira-on-issue-close:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'closed'

    steps:
      - name: Extract Jira Key and Transition to Done
        run: |
          BODY='${{ github.event.issue.body }}'
          JIRA_KEY=$(echo "$BODY" | grep -oE '${{ env.JIRA_PROJECT_KEY }}-[0-9]+' | head -1)
          
          [ -z "$JIRA_KEY" ] && exit 0
          
          TRANSITIONS=$(curl -s -X GET \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${JIRA_KEY}/transitions")
          
          DONE_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name | test("Done|완료|Closed|종료"; "i")) | .id' | head -1)
          
          [ -z "$DONE_ID" ] && exit 0
          
          curl -s -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            -d "{\"transition\": {\"id\": \"$DONE_ID\"}}"

  # GitHub Issue 재오픈 → Jira 상태 복구
  reopen-jira-on-issue-reopen:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'reopened'

    steps:
      - name: Extract Jira Key and Transition to In Progress
        run: |
          BODY='${{ github.event.issue.body }}'
          JIRA_KEY=$(echo "$BODY" | grep -oE '${{ env.JIRA_PROJECT_KEY }}-[0-9]+' | head -1)
          
          [ -z "$JIRA_KEY" ] && exit 0
          
          TRANSITIONS=$(curl -s -X GET \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${JIRA_KEY}/transitions")
          
          PROGRESS_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name | test("In Progress|진행|Open|To Do"; "i")) | .id' | head -1)
          
          [ -z "$PROGRESS_ID" ] && exit 0
          
          curl -s -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            -d "{\"transition\": {\"id\": \"$PROGRESS_ID\"}}"

  # GitHub 코멘트 → Jira 코멘트 동기화
  sync-comment-to-jira:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.action == 'created'

    steps:
      - name: Sync Comment to Jira
        run: |
          BODY='${{ github.event.issue.body }}'
          JIRA_KEY=$(echo "$BODY" | grep -oE '${{ env.JIRA_PROJECT_KEY }}-[0-9]+' | head -1)
          
          [ -z "$JIRA_KEY" ] && exit 0
          
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          COMMENT_BODY=$(echo '${{ github.event.comment.body }}' | head -c 500 | sed 's/"/\\"/g' | tr '\n' ' ')
          
          curl -s -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${JIRA_KEY}/comment" \
            -d "{
              \"body\": {
                \"type\": \"doc\",
                \"version\": 1,
                \"content\": [{\"type\": \"paragraph\", \"content\": [{\"type\": \"text\", \"text\": \"@${COMMENT_AUTHOR}: ${COMMENT_BODY}\"}]}]
              }
            }"
